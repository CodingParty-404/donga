<div th:replace = "includes/header"></div>
<link rel="stylesheet" href="/css/cusSwiper.css" />
<link rel="stylesheet" href="/css/colorpick.css" />

<script src="https://unpkg.com/swiper/js/swiper.js"></script>
<script src="https://unpkg.com/swiper/js/swiper.min.js"></script>
<script src="/js/fabric.js"></script>

<!-- card slide animation -->
<style>
    .card {
        animation-duration: 0.7s;
        animation-name: slidein-card;
        visibility: hidden;
        animation-fill-mode: forwards;
        }
        .textSticker{
            animation-delay: 0s;
        }
        .drawSticker{
            animation-delay: 0.5s;
        }
        .postSticker{
            animation-delay: 0.7s;
        }
        .deleteSticker{
            animation-delay: 0.9s;
        }
        .saveButton{
            animation-delay: 1.1s;
        }
        @keyframes slidein-card {
            from {
                visibility: visible;
                margin-left: 100%;
                width: 100%
            }

            to {
                visibility: visible;
                margin-left: 0%;
                width: 100%;
            }
        }
    .canvas-wrapper{
        margin-top: 100px;
    }
    .canvas-wrapper > div{
        display: inline-block;
        /* outline: 1px solid black; */
    }
    .custom-functions{
        position: relative;
        width: 16vw;
        height: 720px;
    }
    .custom-functions > div{
        width: 16vw;
        display: table;
    }
    .card > * not button{
        display: block;
    }
    .emojis{
        width: 16vw; 
        height: 720px;
        overflow: auto;
    }
</style>
<!-- canvas anima -->
<div class="canvas-wrapper">
    <div class="emojis" >
        <table>
            <tbody>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t1.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t2.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t3.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t4.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t5.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t6.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t7.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t8.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t9.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t10.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t11.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t12.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t13.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t14.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t15.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t16.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t17.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t18.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t19.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t20.png"></td>
                </tr>
                <tr>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t21.png"></td>
                    <td><img draggable="true" ondragstart="drag(event)" src="/emoji/t22.png"></td>
                </tr>
            </tbody>
        </table>
    </div>
    <!-- <canvas id="c1"> </canvas> -->
    <canvas id="c2"> </canvas>
    <div class="custom-functions">
        <div class="card textSticker" >
            <div class="card-header">
                <h5>글자 스티커</h5>
            </div>
            <div class="card-body">
                <input type="text" class="single-input" placeholder="글을 입력하세요!">
                <div class="pickercontainer">
                    <!-- <div class="colorPickSelector"></div> -->
                    <input type="color">
                </div>
                <button type="button" class="genric-btn info circle">글자 스티커 생성</button>
            </div>
        </div>
        <div class="card drawSticker">
            <div class="card-header">
                <h5>스티커 생성</h5>
            </div>
            <div class="card-body" style="display: flex; justify-content: center;">
                <div class="crayonpickercontainer">
                    <!-- <div class="crayonpicker"></div> -->
                    <input type="color">
                </div>
                <button type="submit" class="genric-btn info circle" name="crayon">그리기 시작</button>
                <button type="submit" class="genric-btn danger circle" name="drawEnd">그리기 종료</button>
            </div>
        </div>
        <div class="card postSticker">
            <div class="card-header">
                <h5>일기 쓰기</h5>
            </div>
            <div class="card-body">
                <textarea id="diaryText" class="single-textarea" placeholder="일기를 쓰자" name="diary" maxlength="30" cols="20" rows="5"></textarea>
                <button type="submit" class="genric-btn primary circle " name="diary">내 일기 넣기</button>
            </div>
        </div>
        <div class="card deleteSticker">
            <div class="card-body" style="display: flex; justify-content: center;">
                <button type="button" class="genric-btn danger circle">스티커 삭제</button>
            </div>
        </div>
        <div class="card saveButton">
            <div class="card-body" style="display: flex; justify-content: center;">
                <button type="button" id="complete-button" class="genric-btn success circle">앨범 저장</button>
            </div>
        </div>
    </div>
</div>
<!-- Swiper -->
<div class="swiper-container">
    <div class="swiper-wrapper swiperDIV"></div>
    <div class="swiper-pagination"></div>
</div>

<!-- Json span -->
<div th:each=" vo : ${list}" style="display: none;" >
    <span class="preparedJson" th:text="${vo.getScenepath()}"> </span>
</div>
<!-- prepared canvas -->
<div id="preCanDIV" style="display: none;"></div> 

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>

<!-- init elements -->
<script type="text/javascript">
    var preCan;
    var preFCan=[];
    var preJson;
    var canvasSlide;
    var swiper;
    var comBTN;

    window.onload =
        function (e) {
            createElements();
            initElements();
            canvasLoadJson(preCan,preFCan,preJson,canvasSlide);
            let initIndex = 0;
            initCanvas(canvas2,preJson[0],initIndex);
            comBTN = document.getElementById("complete-button");
            comBTN.addEventListener("click",function(e){
                var curCanvas = canvas2.getElement().getAttribute("data-curCanvas");
                preJson[curCanvas].innerText = JSON.stringify(canvas2.toJSON());
                console.log(preJson[curCanvas].innerHTML);

                var sendForm = document.createElement('form');
                let inputs="<input type='text' name='dongaid' value="+[[${dongaId}]]+">";
                [...preJson].forEach(element => {
                    inputs += "<input type='text' name='jList' value= '"+element.innerText+"' >"
                });
                
                document.body.appendChild(sendForm);
                sendForm.innerHTML = inputs;
                console.log(sendForm.innerHTML);
                sendForm.method="post";
                    // sendForm.submit();
            })
            
        };
    function initCanvas(mainCanvas,firstImg,initIndex){
        console.log("initCan")
        mainCanvas.getElement().setAttribute("data-curCanvas",initIndex)
        mainCanvas.loadFromJSON(firstImg.innerText)
    }

    function createElements(){
        swiper = swiperInit();
        var preCanTXT="";
        var swiperSlide ='<div class="swiper-slide"> <img class="canvasSlide" width="230px" height="80px" src=""> </div>';
        for (let i = 0; i < [[${list.size()}]]; i++) {
                preCanTXT += '<canvas id="can'+i+'" class="preCan"></canvas>';
                swiper.appendSlide(swiperSlide);
            }   
        document.getElementById("preCanDIV").innerHTML=preCanTXT;
    }
    function initElements(){
        preCan = document.getElementsByClassName("preCan");
        preFCan = [];
        preJson = document.getElementsByClassName("preparedJson");
        canvasSlide = document.getElementsByClassName("canvasSlide");
    }      
    function canvasLoadJson(preCan, preFCan, preJson,canvasSlide) {
            for (let i = 0; i < [[${list.size()}]]; i++) {
                preFCan.push(new fabric.Canvas("can" + i))
                preFCan[i].setWidth(1024);
                preFCan[i].setHeight(720);
                preFCan[i].loadFromJSON(preJson[i].innerText,function(){
                    //toBlob메서드 자체가 블럭됨 - 사유 오염된 캔버스
                    preFCan[i].getElement().toBlob(function(blob){
                        var url = URL.createObjectURL(blob);
                        var img = new Image();
                        // img.crossOrigin ="'*'";
                        img.crossOrigin="Anonymous";
                        img = canvasSlide[i];
                        img.src=url;
                        img.onload = function() {
                            URL.revokeObjectURL(this.src);
                        }
                    })
                });
            }
    }
</script>

<!-- <script type="text/javascript" src="/js/colorpick.js">
    var pickcolor = '#000000';
    var $picker = $(".colorPickSelector");
        $picker.colorPick({
            'initialColor': '#000000',
            'onColorSelected': function () {
                this.element.css({
                    'backgroundColor': this.color,
                    'color': this.color
                });
                pickcolor = this.color;
            }
        });
    console.log($picker);
</script> -->

<!-- init Scripts -->
<script>
    // var canvasSticker = document.getElementById("c1");
    //     canvasSticker.width = 250;
    //     canvasSticker.height = 720;

    var canvasScene = document.getElementById("c2");
        canvasScene.width = 1280;
        canvasScene.height = 720;

    // var canvas1 = new fabric.Canvas('c1');
    //     canvas1.setBackgroundColor('rgba(19, 19, 19, 0.25)');
    //     canvas1.renderAll();

    var canvas2 = new fabric.Canvas('c2');
        canvas2.setBackgroundColor('rgba(92, 18, 18, 0.25)');
        canvas2.renderAll();


        function swiperInit() {
            return swiper =
                new Swiper('.swiper-container', {
                    slidesPerView: 1,
                    spaceBetween: 10,
                    pagination: {
                        el: '.swiper-pagination',
                        clickable: true,
                    },
                    on: {
                        click: (e) => { 
                            changeCanvas(this.swiper.clickedIndex) 
                            }
                    },
                    breakpoints: {
                        '@0.00': {
                            slidesPerView: 1,
                            spaceBetween: 10,
                        },
                        '@0.75': {
                            slidesPerView: 3,
                            spaceBetween: 20,
                        },
                        '@1.00': {
                            slidesPerView: 5,
                            spaceBetween: 10,
                        },
                    }
                });
        }
        var changeCanvas = function (index) {
            //슬라이더 클릭
            //내가 작성한 화면이  toJSON으로 변환
            //해당 preJson의 innerText로 저장
            //누른 슬라이더의 JSON값이 캔버스로 로드
            if (typeof(index) === 'number') {
                var curIndex = parseInt(canvas2.getElement().getAttribute("data-curCanvas"));
                preJson[curIndex].innerText = JSON.stringify(canvas2.toJSON());
                var imgSrc = canvas2.getElement()
                .toBlob(function(blob){
                        var url = URL.createObjectURL(blob);
                        var img = canvasSlide[curIndex];
                        img.src=url;
                        img.onload = function() {
                            URL.revokeObjectURL(this.src);
                        }
                })
                canvas2.loadFromJSON(preJson[index].innerText);
                canvas2.getElement().setAttribute("data-curCanvas", index);
            }
            else{
                console.log(index);
            }
        }
</script>

<!-- drag and drop Img add -->
<script>
    function drag(ev){
        ev.dataTransfer.setData("text", ev.target.src);
    }
    var cw = document.getElementsByClassName("canvas-wrapper");
    cw[0].ondrop = (ev)=>{
        console.log(ev.dataTransfer.getData("text"));
        let src = ev.dataTransfer.getData("text");
        console.log(ev)
        let img = new Image();
        img.src = src;
        fabric.Image.fromURL(src,function(oImg){
            oImg.set({left:ev.offsetX-(oImg.width/2),top:ev.offsetY-(oImg.height/2)});
            canvas2.add(oImg);
        })   
    }
    // canvas2.on("object:added", ()=>{console.log("added")})
</script>

<!-- post add -->
<script>
    var diaryBtn = document.querySelector(".postSticker > .card-body > button");
    var diaryText = document.querySelector("#diaryText");
    console.log(diaryBtn);
        console.log(diaryText);
        diaryBtn.addEventListener("click", function () {
            fabric.Image.fromURL('/img/note4.png', function (img) {
                img.scaleToWidth(420);
                img.scaleToHeight(300);

                var str = "";
                var str2 = "";
                var number = 10;
                // function strMaker                
                function strMaker(str) {
                    str = diaryText.value;
                    for (let i = 0; i < str.length / number; i++) {
                        str2 += str.slice(i * number, number * (i + 1)) + "\n";
                    }
                }
                strMaker();
                console.log(str2);

                var text = new fabric.Text(str2, {
                    left: 70,
                    top: 75,
                    fontSize: 18,
                    fontFamily: 'Nanum Gothic',
                    fill: 'black',
                });
                var group = new fabric.Group([img, text], {
                    left: 50,
                    top: 50,
                });
                canvas2.add(group);
            });
        })
</script>

<!-- text Sticker -->
<script>
    var st_TextElement = document.querySelector(".textSticker > .card-body > input");
    var st_ColorElement = document.querySelector(".textSticker > .card-body > .pickercontainer > input");
    var st_ButtonElement = document.querySelector(".textSticker > .card-body > button");

    st_ButtonElement.addEventListener("click",()=>{
        let text = new fabric.Text(st_TextElement.value,{
            fontSize: 30,
            originX: 'center',
            originY: 'center'
        })
        var circle = new fabric.Circle({
                radius: 100,
                fill: st_ColorElement.value,
                scaleY: 0.5,
                originX: 'center',
                originY: 'center'
        });
        var group = new fabric.Group([circle, text], {
                left: 150,
                top: 100,
                angle: -10
        });
        canvas2.add(group);
    })


</script>

<!-- delete Btn-->
<script>
    var deleteBtn = document.querySelector(".deleteSticker> .card-body >button");
    deleteBtn.addEventListener("click", () => {
        if (!(typeof (canvas2.getActiveObject().src) === "string")) {
            canvas2.remove(canvas2.getActiveObject());
        }
    });
</script>

<script>
    var dr_StartbuttonElement = document.querySelector(".drawSticker>.card-body>button[name=crayon]");
    var dr_EndbuttonElement = document.querySelector(".drawSticker>.card-body>button[name=drawEnd]");
    var dr_ColorElement = document.querySelector(".drawSticker>.card-body>.crayonpickercontainer>input");

    dr_StartbuttonElement.addEventListener("click",()=>{
        canvas2.freeDrawingBrush.color = dr_ColorElement.value;
        canvas2.isDrawingMode = true;
        canvas2.freeDrawingBrush.color = dr_ColorElement.value;
        canvas2.freeDrawingBrush.width = 10;
        canvas2.renderAll();
    })
    dr_EndbuttonElement.addEventListener("click",()=>{
        canvas2.isDrawingMode = false;
    })

</script>

<div th:replace = "includes/footer"></div>

